---
layout: page
title: try knitr
---


First Problem as a Whole - Renco
========================================================

I could make this code better but I think nobody cares....

Here it goes




```r
# Read Data into Workspace
ori_portfolio <- read.table("f:/Program Files/RStudio/10 industry portfolio value-weighted daily returns(1984-2012).txt", 
    header = TRUE, sep = "", row.names = "Dates")
ori_factors <- read.table("f:/Program Files/RStudio/F-F_Research_Data_Factors_daily(1984-2012).txt", 
    header = TRUE, row.names = "Dates")
# Construct Excess Return Data

# Define a function to calculate the excess return
getexcessreturn <- function(x) {
    x = x - ori_factors["RF"]
}

portfolio <- data.frame(apply(ori_portfolio, MARGIN = 2, getexcessreturn))
# factors <- data.frame(apply(ori_factors,MARGIN=2,getexcessreturn))
factors <- ori_factors
names(portfolio) <- names(ori_portfolio)
names(factors) <- names(ori_factors)
# Data is now ready

# Problem 1 Pick data for 1984
periods <- 2012 - 1984 + 1
meancor <- rep(0, periods)
quantiles <- matrix(rep(0, 2 * periods), ncol = 2)

for (k in 1984:2012) {
    data <- subset(portfolio, row.names(portfolio) >= k & row.names(portfolio) < 
        (k + 1), )
    correlation <- cor(data)  #get the correlation matrix
    
    sortcor = rep(0, 45)
    pick = 1
    for (i in 1:9) for (j in (i + 1):10) {
        sortcor[pick] = correlation[i, j]
        pick = pick + 1
    }
    sort(sortcor)
    meancor[k - 1983] <- mean(sortcor)
    quantiles[k - 1983, ] = quantile(sortcor, c(0.16, 0.84))
}

years = c(1984:2012)
plot(years, meancor, type = "b", col = "green", main = "MeanCor vs. 16% quantile & 84% quantile", 
    xlab = "Years", ylab = "Correlation", ylim = c(min(quantiles[, 1] - 0.1), 
        1), pch = 19, cex = 1.15, lty = 2)
lines(years, quantiles[, 1], type = "b", col = "red", pch = 17, cex = 0.75)
lines(years, quantiles[, 2], type = "b", col = "blue", pch = 15, cex = 0.75)
legend("bottomright", c("average correlations", "16% quantiles", "84% quantiles"), 
    pch = c(19, 17, 15), col = c("green", "red", "blue"), lty = c(1, 1, 1), 
    cex = 0.75, seg.len = 2)
library(Hmisc)
```

```
## Loading required package: survival
## Loading required package: splines
## Loading required package: Formula
## Hmisc library by Frank E Harrell Jr
## 
## Type library(help='Hmisc'), ?Overview, or ?Hmisc.Overview')
## to see overall documentation.
## 
## 
## Attaching package: 'Hmisc'
## 
## 下列对象被屏蔽了from 'package:survival':
## 
##     untangle.specials
## 
## 下列对象被屏蔽了from 'package:base':
## 
##     format.pval, round.POSIXt, trunc.POSIXt, units
```

```r
minor.tick(nx = 5, tick.ratio = 0.5)
```

![plot of chunk unnamed-chunk-1](figure/unnamed-chunk-1.png) 


```


```r
## Problem 2

# get the data to run linear regression
problem2 <- merge(factors["Mkt.RF"], portfolio, by = "row.names")

# beta contains the Betas for 10 industies betasd contains Betas' standard
# error residuals for ten different
beta_mkt <- rep(0, 10)
betasd_mkt <- rep(0, 10)
residuals_mkt <- as.data.frame(matrix(rep(0, 7313 * 10), ncol = 10), row.names = row.names(portfolio))
names(residuals_mkt) <- names(portfolio)
for (i in 3:12) {
    
    fit <- lm(problem2[, i] ~ Mkt.RF, data = problem2)
    beta_mkt[i - 2] <- coef(fit)[2]
    betasd_mkt[i - 2] <- summary(fit)$coefficients[2, 2]
    residuals_mkt[, i - 2] <- residuals(fit)
}


for (k in 1984:2012) {
    data <- subset(residuals_mkt, row.names(residuals_mkt) >= k & row.names(residuals_mkt) < 
        (k + 1), )
    correlation <- cor(data)  #get the correlation matrix
    
    sortcor = rep(0, 45)
    pick = 1
    for (i in 1:9) for (j in (i + 1):10) {
        sortcor[pick] = correlation[i, j]
        pick = pick + 1
    }
    sort(sortcor)
    meancor[k - 1983] <- mean(sortcor)
    quantiles[k - 1983, ] = quantile(sortcor, c(0.16, 0.84))
}

years = c(1984:2012)
plot(years, meancor, type = "b", col = "green", main = "MeanCor vs. 16% quantile & 84% quantile", 
    xlab = "Years", ylab = "Correlation", ylim = c(min(quantiles[, 1] - 0.1), 
        1), pch = 19, cex = 1.15, lty = 2)
lines(years, quantiles[, 1], type = "b", col = "red", pch = 17, cex = 0.75)
lines(years, quantiles[, 2], type = "b", col = "blue", pch = 15, cex = 0.75)
abline(h = 0, lty = 2, col = "purple", lwd = 2.5)
legend("topright", c("average correlations", "16% quantiles", "84% quantiles", 
    "Refrence Line of Zero Correlation"), pch = c(19, 17, 15), col = c("green", 
    "red", "blue", "purple"), lty = c(1, 1, 1), cex = 0.75, seg.len = 2)
minor.tick(nx = 5, tick.ratio = 0.5)
```

![plot of chunk unnamed-chunk-2](figure/unnamed-chunk-2.png) 



```r
## Problem3

# get the data to run linear regression
problem3 <- merge(factors[c("Mkt.RF", "SMB", "HML")], portfolio, by = "row.names")

beta_fac <- matrix(rep(0, 30), ncol = 3)
betasd_fac <- matrix(rep(0, 30), ncol = 3)
residuals_fac <- as.data.frame(matrix(rep(0, 7313 * 10), ncol = 10), row.names = row.names(portfolio))
names(residuals_fac) <- names(portfolio)
for (i in 5:14) {
    
    fit <- lm(problem3[, i] ~ Mkt.RF + SMB + HML, data = problem3)
    beta_fac[i - 4, ] <- coef(fit)[2:4]
    betasd_fac[i - 4, ] <- summary(fit)$coefficients[2:4, 2]
    residuals_fac[, i - 4] <- residuals(fit)
}


# Get Correlation Matrix for betas of the factors
cor_fac = cor(beta_fac)
cor_fac
```

```
##          [,1]    [,2]     [,3]
## [1,]  1.00000  0.8584 -0.03641
## [2,]  0.85843  1.0000 -0.10852
## [3,] -0.03641 -0.1085  1.00000
```

```r

# Get Table1
table1 <- data.frame(beta_mkt, beta_fac)
table1sd <- data.frame(betasd_mkt, betasd_fac)

# Draw Figure 3
for (k in 1984:2012) {
    data <- subset(residuals_fac, row.names(residuals_fac) >= k & row.names(residuals_fac) < 
        (k + 1), )
    correlation <- cor(data)  #get the correlation matrix
    
    sortcor = rep(0, 45)
    pick = 1
    for (i in 1:9) for (j in (i + 1):10) {
        sortcor[pick] = correlation[i, j]
        pick = pick + 1
    }
    sort(sortcor)
    meancor[k - 1983] <- mean(sortcor)
    quantiles[k - 1983, ] = quantile(sortcor, c(0.16, 0.84))
}

years = c(1984:2012)
plot(years, meancor, type = "b", col = "green", main = "MeanCor vs. 16% quantile & 84% quantile", 
    xlab = "Years", ylab = "Correlation", ylim = c(min(quantiles[, 1] - 0.1), 
        1), pch = 19, cex = 1.15, lty = 2)
lines(years, quantiles[, 1], type = "b", col = "red", pch = 17, cex = 0.75)
lines(years, quantiles[, 2], type = "b", col = "blue", pch = 15, cex = 0.75)
abline(h = 0, lty = 2, col = "purple", lwd = 2.5)
legend("topright", c("average correlations", "16% quantiles", "84% quantiles", 
    "Refrence Line of Zero Correlation"), pch = c(19, 17, 15), col = c("green", 
    "red", "blue", "purple"), lty = c(1, 1, 1), cex = 0.75, seg.len = 2)
minor.tick(nx = 5, tick.ratio = 0.5)
```

![plot of chunk unnamed-chunk-3](figure/unnamed-chunk-3.png) 



```r
## Problem4

problem4 <- data.frame(problem3, row.names = "Row.names")
premium <- data.frame(seq(1985, 2012), matrix(rep(0, (2012 - 1984) * 3), ncol = 3), 
    row.names = 1)
capmtest <- data.frame(matrix(rep(0, 40), ncol = 4))
names(capmtest) <- c("Return", "Mkt.RF", "SMB", "HML")

for (k in 1984:2011) {
    data_dyna <- subset(problem4, row.names(problem4) >= k & row.names(problem4) < 
        (k + 1), )
    beta_dyna <- matrix(rep(0, 30), ncol = 3)
    
    for (i in 4:13) {
        
        fit <- lm(data_dyna[, i] ~ Mkt.RF + SMB + HML, data = data_dyna)
        beta_dyna[i - 3, ] <- coef(fit)[2:4]
        
    }
    
    capmtest[, 2:4] <- capmtest[, 2:4] + beta_dyna
    
    data_dyna2 <- subset(problem4, row.names(problem4) >= (k + 1) & row.names(problem4) < 
        (k + 2), )
    rtotal <- as.data.frame(rep(0, 10))
    for (s in 1:10) {
        
        rtotal[s, 1] = sum(data_dyna2[, (s + 3)])
    }
    
    capmtest[, 1] <- capmtest[, 1] + rtotal
    
    fit2 <- lm(rtotal[, 1] ~ beta_dyna)
    premium[(k - 1983), ] <- coef(fit2)[2:4]
}

plot(row.names(premium), premium[, 1], type = "b", col = "green", main = "Figure 4", 
    xlab = "Years", ylab = "Premium for Mkt.RF", pch = 19, cex = 1, lty = 2)
```

![plot of chunk unnamed-chunk-4](figure/unnamed-chunk-41.png) 

```r
plot(row.names(premium), premium[, 2], type = "b", col = "red", pch = 17, cex = 1, 
    xlab = "Years", ylab = "Premium for SMB", lty = 2, main = "Figure 5")
```

![plot of chunk unnamed-chunk-4](figure/unnamed-chunk-42.png) 

```r
plot(row.names(premium), premium[, 3], type = "b", col = "blue", pch = 17, cex = 1, 
    xlab = "Years", ylab = "Premium for HML", lty = 2, main = "Figure 6")
```

![plot of chunk unnamed-chunk-4](figure/unnamed-chunk-43.png) 

```r




capmtest <- capmtest/28
capm <- lm(Return ~ Mkt.RF + SMB + HML, data = capmtest)
summary(capm)
```

```
## 
## Call:
## lm(formula = Return ~ Mkt.RF + SMB + HML, data = capmtest)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -1.8029 -0.9582 -0.0095  0.7232  2.2157 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)  
## (Intercept)   12.740      5.409    2.36    0.057 .
## Mkt.RF        -4.137      5.375   -0.77    0.471  
## SMB           -1.034      5.596   -0.18    0.860  
## HML           -0.609      1.029   -0.59    0.576  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.5 on 6 degrees of freedom
## Multiple R-squared:  0.309,	Adjusted R-squared:  -0.0364 
## F-statistic: 0.895 on 3 and 6 DF,  p-value: 0.496
```



```r
## Problem 5

# get data ready
problem5 <- subset(problem4, row.names(problem4) >= 1991 & row.names(problem4) < 
    2001, 1:5)


## Now We construct a SUR model
Y <- matrix(c(problem5[, 4], problem5[, 5]), ncol = 1)
null <- matrix(rep(0, dim(problem5)[1] * 4), ncol = 4)
ones <- matrix(rep(1, dim(problem5)[1]), ncol = 1)
X <- rbind(cbind(ones, as.matrix(problem5[, 1:3]), null), cbind(null, ones, 
    as.matrix(problem5[, 1:3])))
I <- diag(rep(1, dim(problem5)[1]))
SIGMA = kronecker(cor(problem5[, 4:5]), I)

# Now Use GLS to get Betas
betasur <- solve(t(X) %*% solve(SIGMA) %*% X) %*% t(X) %*% solve(SIGMA) %*% 
    Y
betasur
```

```
##             [,1]
##         0.001632
## Mkt.RF  0.690690
## SMB    -0.379106
## HML     0.182381
##        -0.039178
##         1.307516
##         0.107619
##         1.012984
```

```r


## testing the difference of betas now Get transformed data
BETATEST <- data.frame(Y, X, row.names = NULL)
names(BETATEST) <- c("Return", "intercept1", "theta_RF", "theta_SMB", "theta_HML", 
    "intercept2", "Mkt.RF", "SMB", "HML")
# NOw transform according to Wooldridge
for (i in 3:5) BETATEST[, (i + 4)] = BETATEST[, (i + 4)] + BETATEST[, i]

require(nlme)
```

```
## Loading required package: nlme
```

```r
BETADIF <- gls(Return ~ theta_RF + theta_SMB + theta_HML + intercept2 + Mkt.RF + 
    SMB + HML, data = BETATEST)
summary(BETADIF)
```

```
## Generalized least squares fit by REML
##   Model: Return ~ theta_RF + theta_SMB + theta_HML + intercept2 + Mkt.RF +      SMB + HML 
##   Data: BETATEST 
##     AIC   BIC logLik
##   10736 10794  -5359
## 
## Coefficients:
##               Value Std.Error t-value p-value
## (Intercept)  0.0016   0.01393    0.12  0.9068
## theta_RF    -0.6168   0.03441  -17.93  0.0000
## theta_SMB   -0.4867   0.04157  -11.71  0.0000
## theta_HML   -0.8306   0.05437  -15.28  0.0000
## intercept2  -0.0408   0.01971   -2.07  0.0384
## Mkt.RF       1.3075   0.02433   53.74  0.0000
## SMB          0.1076   0.02939    3.66  0.0003
## HML          1.0130   0.03844   26.35  0.0000
## 
##  Correlation: 
##            (Intr) tht_RF th_SMB th_HML intrc2 Mkt.RF SMB   
## theta_RF   -0.079                                          
## theta_SMB  -0.041  0.523                                   
## theta_HML  -0.071  0.778  0.528                            
## intercept2 -0.707  0.111  0.058  0.100                     
## Mkt.RF      0.000 -0.707 -0.370 -0.550 -0.079              
## SMB         0.000 -0.370 -0.707 -0.373 -0.041  0.523       
## HML         0.000 -0.550 -0.373 -0.707 -0.071  0.778  0.528
## 
## Standardized residuals:
##      Min       Q1      Med       Q3      Max 
## -5.67579 -0.53544 -0.01468  0.51054  5.17092 
## 
## Residual standard error: 0.6959 
## Degrees of freedom: 5054 total; 5046 residual
```

```r

## Read the p values for every theta to know that the betas for two
## industries are different
```

